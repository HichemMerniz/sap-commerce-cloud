{"version":3,"sources":["node_modules/@spartacus/tracking/fesm2022/spartacus-tracking-personalization-root.mjs"],"sourcesContent":["import * as i0 from '@angular/core';\nimport { Injectable, inject, isDevMode, NgModule } from '@angular/core';\nimport * as i2 from '@spartacus/core';\nimport { Config, LoggerService, provideDefaultConfig, provideDefaultConfigFactory } from '@spartacus/core';\nimport { HttpResponse, HTTP_INTERCEPTORS } from '@angular/common/http';\nimport { tap } from 'rxjs/operators';\n\n/*\n * SPDX-FileCopyrightText: 2024 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\nclass PersonalizationConfig {\n  static {\n    this.ɵfac = function PersonalizationConfig_Factory(t) {\n      return new (t || PersonalizationConfig)();\n    };\n  }\n  static {\n    this.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n      token: PersonalizationConfig,\n      factory: function PersonalizationConfig_Factory(t) {\n        let r = null;\n        if (t) {\n          r = new (t || PersonalizationConfig)();\n        } else {\n          r = i0.ɵɵinject(Config);\n        }\n        return r;\n      },\n      providedIn: 'root'\n    });\n  }\n}\n(() => {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(PersonalizationConfig, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root',\n      useExisting: Config\n    }]\n  }], null, null);\n})();\n\n/*\n * SPDX-FileCopyrightText: 2024 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\nconst PERSONALIZATION_FEATURE = 'personalization';\n\n/*\n * SPDX-FileCopyrightText: 2024 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\nconst defaultPersonalizationConfig = {\n  personalization: {\n    enabled: false,\n    httpHeaderName: {\n      id: 'Occ-Personalization-Id',\n      timestamp: 'Occ-Personalization-Time'\n    },\n    context: {\n      slotPosition: 'PlaceholderContentSlot',\n      componentId: 'PersonalizationScriptComponent'\n    }\n  }\n};\n\n/*\n * SPDX-FileCopyrightText: 2024 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\nclass OccPersonalizationIdInterceptor {\n  constructor(config, occEndpoints, winRef) {\n    this.config = config;\n    this.occEndpoints = occEndpoints;\n    this.winRef = winRef;\n    this.enabled = false;\n    this.PERSONALIZATION_ID_KEY = 'personalization-id';\n    this.logger = inject(LoggerService);\n    if (this.winRef.isBrowser()) {\n      this.enabled = this.winRef.localStorage && this.config.personalization?.enabled || false;\n      if (this.enabled) {\n        if (!this.config.personalization?.httpHeaderName && isDevMode()) {\n          this.logger.warn(`There is no httpHeaderName configured in Personalization`);\n        }\n        this.requestHeader = this.config.personalization?.httpHeaderName?.id.toLowerCase();\n        this.personalizationId = this.winRef.localStorage?.getItem(this.PERSONALIZATION_ID_KEY);\n      } else if (this.winRef.localStorage?.getItem(this.PERSONALIZATION_ID_KEY)) {\n        this.winRef.localStorage.removeItem(this.PERSONALIZATION_ID_KEY);\n      }\n    }\n  }\n  intercept(request, next) {\n    if (!this.enabled) {\n      return next.handle(request);\n    }\n    if (this.requestHeader && this.personalizationId && request.url.includes(this.occEndpoints.getBaseUrl())) {\n      request = request.clone({\n        setHeaders: {\n          [this.requestHeader]: this.personalizationId\n        }\n      });\n    }\n    return next.handle(request).pipe(tap(event => {\n      if (event instanceof HttpResponse && this.requestHeader && event.headers.keys().includes(this.requestHeader)) {\n        const receivedId = event.headers.get(this.requestHeader);\n        if (this.personalizationId !== receivedId) {\n          this.personalizationId = receivedId;\n          if (this.personalizationId) {\n            this.winRef.localStorage?.setItem(this.PERSONALIZATION_ID_KEY, this.personalizationId);\n          }\n        }\n      }\n    }));\n  }\n  static {\n    this.ɵfac = function OccPersonalizationIdInterceptor_Factory(t) {\n      return new (t || OccPersonalizationIdInterceptor)(i0.ɵɵinject(PersonalizationConfig), i0.ɵɵinject(i2.OccEndpointsService), i0.ɵɵinject(i2.WindowRef));\n    };\n  }\n  static {\n    this.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n      token: OccPersonalizationIdInterceptor,\n      factory: OccPersonalizationIdInterceptor.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}\n(() => {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(OccPersonalizationIdInterceptor, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root'\n    }]\n  }], () => [{\n    type: PersonalizationConfig\n  }, {\n    type: i2.OccEndpointsService\n  }, {\n    type: i2.WindowRef\n  }], null);\n})();\n\n/*\n * SPDX-FileCopyrightText: 2024 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\nclass OccPersonalizationTimeInterceptor {\n  constructor(config, occEndpoints, winRef) {\n    this.config = config;\n    this.occEndpoints = occEndpoints;\n    this.winRef = winRef;\n    this.enabled = false;\n    this.PERSONALIZATION_TIME_KEY = 'personalization-time';\n    this.logger = inject(LoggerService);\n    if (this.winRef.isBrowser()) {\n      this.enabled = this.winRef.localStorage && this.config.personalization?.enabled || false;\n      if (this.enabled) {\n        if (!this.config.personalization?.httpHeaderName && isDevMode()) {\n          this.logger.warn(`There is no httpHeaderName configured in Personalization`);\n        }\n        this.requestHeader = this.config.personalization?.httpHeaderName?.timestamp.toLowerCase();\n        this.timestamp = this.winRef.localStorage?.getItem(this.PERSONALIZATION_TIME_KEY);\n      } else if (this.winRef.localStorage?.getItem(this.PERSONALIZATION_TIME_KEY)) {\n        this.winRef.localStorage.removeItem(this.PERSONALIZATION_TIME_KEY);\n      }\n    }\n  }\n  intercept(request, next) {\n    if (!this.enabled) {\n      return next.handle(request);\n    }\n    if (this.requestHeader && this.timestamp && request.url.includes(this.occEndpoints.getBaseUrl())) {\n      request = request.clone({\n        setHeaders: {\n          [this.requestHeader]: this.timestamp\n        }\n      });\n    }\n    return next.handle(request).pipe(tap(event => {\n      if (event instanceof HttpResponse && this.requestHeader && event.headers.keys().includes(this.requestHeader)) {\n        const receivedTimestamp = event.headers.get(this.requestHeader);\n        if (this.timestamp !== receivedTimestamp) {\n          this.timestamp = receivedTimestamp;\n          if (this.timestamp) {\n            this.winRef.localStorage?.setItem(this.PERSONALIZATION_TIME_KEY, this.timestamp);\n          }\n        }\n      }\n    }));\n  }\n  static {\n    this.ɵfac = function OccPersonalizationTimeInterceptor_Factory(t) {\n      return new (t || OccPersonalizationTimeInterceptor)(i0.ɵɵinject(PersonalizationConfig), i0.ɵɵinject(i2.OccEndpointsService), i0.ɵɵinject(i2.WindowRef));\n    };\n  }\n  static {\n    this.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n      token: OccPersonalizationTimeInterceptor,\n      factory: OccPersonalizationTimeInterceptor.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}\n(() => {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(OccPersonalizationTimeInterceptor, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root'\n    }]\n  }], () => [{\n    type: PersonalizationConfig\n  }, {\n    type: i2.OccEndpointsService\n  }, {\n    type: i2.WindowRef\n  }], null);\n})();\n\n/*\n * SPDX-FileCopyrightText: 2024 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\nconst interceptors = [{\n  provide: HTTP_INTERCEPTORS,\n  useExisting: OccPersonalizationIdInterceptor,\n  multi: true\n}, {\n  provide: HTTP_INTERCEPTORS,\n  useExisting: OccPersonalizationTimeInterceptor,\n  multi: true\n}];\n\n/*\n * SPDX-FileCopyrightText: 2024 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n// TODO: Inline this factory when we start releasing Ivy compiled libraries\nfunction defaultPersonalizationComponentsConfig() {\n  const config = {\n    featureModules: {\n      [PERSONALIZATION_FEATURE]: {\n        cmsComponents: ['PersonalizationScriptComponent']\n      }\n    }\n  };\n  return config;\n}\nclass PersonalizationRootModule {\n  static {\n    this.ɵfac = function PersonalizationRootModule_Factory(t) {\n      return new (t || PersonalizationRootModule)();\n    };\n  }\n  static {\n    this.ɵmod = /* @__PURE__ */i0.ɵɵdefineNgModule({\n      type: PersonalizationRootModule\n    });\n  }\n  static {\n    this.ɵinj = /* @__PURE__ */i0.ɵɵdefineInjector({\n      providers: [...interceptors, provideDefaultConfig(defaultPersonalizationConfig), provideDefaultConfigFactory(defaultPersonalizationComponentsConfig)]\n    });\n  }\n}\n(() => {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(PersonalizationRootModule, [{\n    type: NgModule,\n    args: [{\n      providers: [...interceptors, provideDefaultConfig(defaultPersonalizationConfig), provideDefaultConfigFactory(defaultPersonalizationComponentsConfig)]\n    }]\n  }], null, null);\n})();\n\n/*\n * SPDX-FileCopyrightText: 2024 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\n/**\n * Generated bundle index. Do not edit.\n */\n\nexport { OccPersonalizationIdInterceptor, OccPersonalizationTimeInterceptor, PERSONALIZATION_FEATURE, PersonalizationConfig, PersonalizationRootModule, defaultPersonalizationComponentsConfig };\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAYA,IAAM,yBAAN,MAAM,uBAAsB;AAqB5B;AAnBI,uBAAK,YAAO,SAAS,8BAA8B,GAAG;AACpD,SAAO,KAAK,KAAK,wBAAuB;AAC1C;AAGA,uBAAK,aAAuB,gBAAG,6BAAmB;AAAA,EAChD,OAAO;AAAA,EACP,SAAS,SAAS,8BAA8B,GAAG;AACjD,QAAI,IAAI;AACR,QAAI,GAAG;AACL,UAAI,KAAK,KAAK,wBAAuB;AAAA,IACvC,OAAO;AACL,UAAO,mBAAS,MAAM;AAAA,IACxB;AACA,WAAO;AAAA,EACT;AAAA,EACA,YAAY;AACd,CAAC;AAnBL,IAAM,wBAAN;AAAA,CAsBC,MAAM;AACL,GAAC,OAAO,cAAc,eAAe,cAAiB,iBAAkB,uBAAuB,CAAC;AAAA,IAC9F,MAAM;AAAA,IACN,MAAM,CAAC;AAAA,MACL,YAAY;AAAA,MACZ,aAAa;AAAA,IACf,CAAC;AAAA,EACH,CAAC,GAAG,MAAM,IAAI;AAChB,GAAG;AAOH,IAAM,0BAA0B;AAOhC,IAAM,+BAA+B;AAAA,EACnC,iBAAiB;AAAA,IACf,SAAS;AAAA,IACT,gBAAgB;AAAA,MACd,IAAI;AAAA,MACJ,WAAW;AAAA,IACb;AAAA,IACA,SAAS;AAAA,MACP,cAAc;AAAA,MACd,aAAa;AAAA,IACf;AAAA,EACF;AACF;AAOA,IAAM,mCAAN,MAAM,iCAAgC;AAAA,EACpC,YAAY,QAAQ,cAAc,QAAQ;AACxC,SAAK,SAAS;AACd,SAAK,eAAe;AACpB,SAAK,SAAS;AACd,SAAK,UAAU;AACf,SAAK,yBAAyB;AAC9B,SAAK,SAAS,OAAO,aAAa;AAClC,QAAI,KAAK,OAAO,UAAU,GAAG;AAC3B,WAAK,UAAU,KAAK,OAAO,gBAAgB,KAAK,OAAO,iBAAiB,WAAW;AACnF,UAAI,KAAK,SAAS;AAChB,YAAI,CAAC,KAAK,OAAO,iBAAiB,kBAAkB,UAAU,GAAG;AAC/D,eAAK,OAAO,KAAK,0DAA0D;AAAA,QAC7E;AACA,aAAK,gBAAgB,KAAK,OAAO,iBAAiB,gBAAgB,GAAG,YAAY;AACjF,aAAK,oBAAoB,KAAK,OAAO,cAAc,QAAQ,KAAK,sBAAsB;AAAA,MACxF,WAAW,KAAK,OAAO,cAAc,QAAQ,KAAK,sBAAsB,GAAG;AACzE,aAAK,OAAO,aAAa,WAAW,KAAK,sBAAsB;AAAA,MACjE;AAAA,IACF;AAAA,EACF;AAAA,EACA,UAAU,SAAS,MAAM;AACvB,QAAI,CAAC,KAAK,SAAS;AACjB,aAAO,KAAK,OAAO,OAAO;AAAA,IAC5B;AACA,QAAI,KAAK,iBAAiB,KAAK,qBAAqB,QAAQ,IAAI,SAAS,KAAK,aAAa,WAAW,CAAC,GAAG;AACxG,gBAAU,QAAQ,MAAM;AAAA,QACtB,YAAY;AAAA,UACV,CAAC,KAAK,aAAa,GAAG,KAAK;AAAA,QAC7B;AAAA,MACF,CAAC;AAAA,IACH;AACA,WAAO,KAAK,OAAO,OAAO,EAAE,KAAK,IAAI,WAAS;AAC5C,UAAI,iBAAiB,gBAAgB,KAAK,iBAAiB,MAAM,QAAQ,KAAK,EAAE,SAAS,KAAK,aAAa,GAAG;AAC5G,cAAM,aAAa,MAAM,QAAQ,IAAI,KAAK,aAAa;AACvD,YAAI,KAAK,sBAAsB,YAAY;AACzC,eAAK,oBAAoB;AACzB,cAAI,KAAK,mBAAmB;AAC1B,iBAAK,OAAO,cAAc,QAAQ,KAAK,wBAAwB,KAAK,iBAAiB;AAAA,UACvF;AAAA,QACF;AAAA,MACF;AAAA,IACF,CAAC,CAAC;AAAA,EACJ;AAaF;AAXI,iCAAK,YAAO,SAAS,wCAAwC,GAAG;AAC9D,SAAO,KAAK,KAAK,kCAAoC,mBAAS,qBAAqB,GAAM,mBAAY,mBAAmB,GAAM,mBAAY,SAAS,CAAC;AACtJ;AAGA,iCAAK,aAAuB,gBAAG,6BAAmB;AAAA,EAChD,OAAO;AAAA,EACP,SAAS,iCAAgC;AAAA,EACzC,YAAY;AACd,CAAC;AAtDL,IAAM,kCAAN;AAAA,CAyDC,MAAM;AACL,GAAC,OAAO,cAAc,eAAe,cAAiB,iBAAkB,iCAAiC,CAAC;AAAA,IACxG,MAAM;AAAA,IACN,MAAM,CAAC;AAAA,MACL,YAAY;AAAA,IACd,CAAC;AAAA,EACH,CAAC,GAAG,MAAM,CAAC;AAAA,IACT,MAAM;AAAA,EACR,GAAG;AAAA,IACD,MAAS;AAAA,EACX,GAAG;AAAA,IACD,MAAS;AAAA,EACX,CAAC,GAAG,IAAI;AACV,GAAG;AAOH,IAAM,qCAAN,MAAM,mCAAkC;AAAA,EACtC,YAAY,QAAQ,cAAc,QAAQ;AACxC,SAAK,SAAS;AACd,SAAK,eAAe;AACpB,SAAK,SAAS;AACd,SAAK,UAAU;AACf,SAAK,2BAA2B;AAChC,SAAK,SAAS,OAAO,aAAa;AAClC,QAAI,KAAK,OAAO,UAAU,GAAG;AAC3B,WAAK,UAAU,KAAK,OAAO,gBAAgB,KAAK,OAAO,iBAAiB,WAAW;AACnF,UAAI,KAAK,SAAS;AAChB,YAAI,CAAC,KAAK,OAAO,iBAAiB,kBAAkB,UAAU,GAAG;AAC/D,eAAK,OAAO,KAAK,0DAA0D;AAAA,QAC7E;AACA,aAAK,gBAAgB,KAAK,OAAO,iBAAiB,gBAAgB,UAAU,YAAY;AACxF,aAAK,YAAY,KAAK,OAAO,cAAc,QAAQ,KAAK,wBAAwB;AAAA,MAClF,WAAW,KAAK,OAAO,cAAc,QAAQ,KAAK,wBAAwB,GAAG;AAC3E,aAAK,OAAO,aAAa,WAAW,KAAK,wBAAwB;AAAA,MACnE;AAAA,IACF;AAAA,EACF;AAAA,EACA,UAAU,SAAS,MAAM;AACvB,QAAI,CAAC,KAAK,SAAS;AACjB,aAAO,KAAK,OAAO,OAAO;AAAA,IAC5B;AACA,QAAI,KAAK,iBAAiB,KAAK,aAAa,QAAQ,IAAI,SAAS,KAAK,aAAa,WAAW,CAAC,GAAG;AAChG,gBAAU,QAAQ,MAAM;AAAA,QACtB,YAAY;AAAA,UACV,CAAC,KAAK,aAAa,GAAG,KAAK;AAAA,QAC7B;AAAA,MACF,CAAC;AAAA,IACH;AACA,WAAO,KAAK,OAAO,OAAO,EAAE,KAAK,IAAI,WAAS;AAC5C,UAAI,iBAAiB,gBAAgB,KAAK,iBAAiB,MAAM,QAAQ,KAAK,EAAE,SAAS,KAAK,aAAa,GAAG;AAC5G,cAAM,oBAAoB,MAAM,QAAQ,IAAI,KAAK,aAAa;AAC9D,YAAI,KAAK,cAAc,mBAAmB;AACxC,eAAK,YAAY;AACjB,cAAI,KAAK,WAAW;AAClB,iBAAK,OAAO,cAAc,QAAQ,KAAK,0BAA0B,KAAK,SAAS;AAAA,UACjF;AAAA,QACF;AAAA,MACF;AAAA,IACF,CAAC,CAAC;AAAA,EACJ;AAaF;AAXI,mCAAK,YAAO,SAAS,0CAA0C,GAAG;AAChE,SAAO,KAAK,KAAK,oCAAsC,mBAAS,qBAAqB,GAAM,mBAAY,mBAAmB,GAAM,mBAAY,SAAS,CAAC;AACxJ;AAGA,mCAAK,aAAuB,gBAAG,6BAAmB;AAAA,EAChD,OAAO;AAAA,EACP,SAAS,mCAAkC;AAAA,EAC3C,YAAY;AACd,CAAC;AAtDL,IAAM,oCAAN;AAAA,CAyDC,MAAM;AACL,GAAC,OAAO,cAAc,eAAe,cAAiB,iBAAkB,mCAAmC,CAAC;AAAA,IAC1G,MAAM;AAAA,IACN,MAAM,CAAC;AAAA,MACL,YAAY;AAAA,IACd,CAAC;AAAA,EACH,CAAC,GAAG,MAAM,CAAC;AAAA,IACT,MAAM;AAAA,EACR,GAAG;AAAA,IACD,MAAS;AAAA,EACX,GAAG;AAAA,IACD,MAAS;AAAA,EACX,CAAC,GAAG,IAAI;AACV,GAAG;AAOH,IAAM,eAAe,CAAC;AAAA,EACpB,SAAS;AAAA,EACT,aAAa;AAAA,EACb,OAAO;AACT,GAAG;AAAA,EACD,SAAS;AAAA,EACT,aAAa;AAAA,EACb,OAAO;AACT,CAAC;AAQD,SAAS,yCAAyC;AAChD,QAAM,SAAS;AAAA,IACb,gBAAgB;AAAA,MACd,CAAC,uBAAuB,GAAG;AAAA,QACzB,eAAe,CAAC,gCAAgC;AAAA,MAClD;AAAA,IACF;AAAA,EACF;AACA,SAAO;AACT;AACA,IAAM,6BAAN,MAAM,2BAA0B;AAgBhC;AAdI,2BAAK,YAAO,SAAS,kCAAkC,GAAG;AACxD,SAAO,KAAK,KAAK,4BAA2B;AAC9C;AAGA,2BAAK,YAAsB,gBAAG,2BAAiB;AAAA,EAC7C,MAAM;AACR,CAAC;AAGD,2BAAK,YAAsB,gBAAG,2BAAiB;AAAA,EAC7C,WAAW,CAAC,GAAG,cAAc,qBAAqB,4BAA4B,GAAG,4BAA4B,sCAAsC,CAAC;AACtJ,CAAC;AAdL,IAAM,4BAAN;AAAA,CAiBC,MAAM;AACL,GAAC,OAAO,cAAc,eAAe,cAAiB,iBAAkB,2BAA2B,CAAC;AAAA,IAClG,MAAM;AAAA,IACN,MAAM,CAAC;AAAA,MACL,WAAW,CAAC,GAAG,cAAc,qBAAqB,4BAA4B,GAAG,4BAA4B,sCAAsC,CAAC;AAAA,IACtJ,CAAC;AAAA,EACH,CAAC,GAAG,MAAM,IAAI;AAChB,GAAG;","names":[],"x_google_ignoreList":[0]}